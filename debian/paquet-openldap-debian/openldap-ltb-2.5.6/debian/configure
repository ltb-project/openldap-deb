#!/bin/bash

BASEDIR=$(dirname $0)
source $BASEDIR/openldap-ltb.vars


export CC="gcc"
export CFLAGS="-DOPENLDAP_FD_SETSIZE=4096 -DSLAP_SCHEMA_EXPOSE -O2 -g"
export CPPFLAGS="-I${BDBDIR}/include -I/usr/kerberos/include"
export LDFLAGS="-L${BDBDIR}/lib"

if [[ ${REAL_VERSION} == "2.4.43" ]]; then
  # Bug with mdb detection of robust mutex: pthread_mutex_consistent and
  # pthread_mutex_robust not defined in pthread.h but some set variables
  # let suppose they are
  patch --forward -p0 -d ${BUILD_DIR} < ${BASEDIR}/0001-Fix-robust-mutex-detection-for-glibc-2.10-and-2.11.patch
fi

./configure --prefix=${LDAPDIR} --libdir=${LDAPDIR}/${_LIB} --enable-modules=yes --enable-overlays=mod --enable-backends=mod --enable-dynamic=yes --with-tls=openssl --enable-debug --with-cyrus-sasl --enable-spasswd --enable-ppolicy=mod --enable-crypt --enable-slapi --enable-mdb=mod --enable-ldap=mod --enable-meta=mod --enable-sock=mod --enable-wrappers --enable-rlookups --enable-argon2=yes --enable-otp=mod --enable-balancer=mod --enable-sql=no --enable-ndb=no --enable-wt=no --enable-shell=no --enable-perl=no
